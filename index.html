// Generate and Play button click handler
generateAndPlayBtn.addEventListener('click', async () => {
  const text = textInput.value.trim();
  if (text === '') {
    showMessage('Please enter some text to convert to speech.', true);
    return;
  }

  // Show loading indicator and disable buttons
  ttsLoadingMessage.classList.remove('hidden');
  generateAndPlayBtn.disabled = true;
  audioPlayer.classList.add('hidden');
  messageBox.classList.add('hidden');

  try {
    // Call the Vercel serverless function
    const apiUrl = '/api/synthesize'; // Serverless function endpoint

    const payload = {
      input: {
        text: text
      },
      voice: {
        languageCode: 'en-US',
        name: 'en-US-Wavenet-F'
      },
      audioConfig: {
        audioEncoding: 'LINEAR16',
        sampleRateHertz: 24000
      }
    };

    let response;
    const maxRetries = 3;
    let retryCount = 0;
    let delay = 1000;

    while (retryCount < maxRetries) {
      try {
        response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (response.status !== 429) {
          break;
        }

        console.warn(`API call failed with status 429. Retrying in ${delay}ms...`);
        await new Promise(resolve => setTimeout(resolve, delay));
        delay *= 2;
        retryCount++;
      } catch (fetchError) {
        console.error('Fetch attempt failed:', fetchError);
        throw fetchError;
      }
    }

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`API call failed with status: ${response.status}. Response body: ${errorText}`);
    }

    const result = await response.json();

    const audioData = result?.audioContent;
    if (audioData) {
      const sampleRate = payload.audioConfig.sampleRateHertz;
      const pcmData = base64ToArrayBuffer(audioData);
      const pcm16 = new Int16Array(pcmData);
      const wavBlob = pcmToWav(pcm16, sampleRate);
      const audioUrl = URL.createObjectURL(wavBlob);

      audioPlayer.src = audioUrl;
      audioPlayer.classList.remove('hidden');
      audioPlayer.play();

      showMessage('Audio generated and playing successfully!', false);
    } else {
      throw new Error('No audio data or invalid format received from API.');
    }
  } catch (error) {
    console.error('Error:', error);
    showMessage(`Error: ${error.message}`, true);
  } finally {
    ttsLoadingMessage.classList.add('hidden');
    generateAndPlayBtn.disabled = false;
  }
});
